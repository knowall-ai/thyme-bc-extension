name: Deploy to Sandbox (Contoso)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    environment: Sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install BcContainerHelper
        shell: powershell
        run: |
          Install-Module BcContainerHelper -Force -AllowClobber
          Import-Module BcContainerHelper

      - name: Build and Deploy to Sandbox
        shell: powershell
        env:
          BC_TENANT_ID: ${{ secrets.BC_TENANT_ID }}
          BC_CLIENT_ID: ${{ secrets.BC_CLIENT_ID }}
          BC_CLIENT_SECRET: ${{ secrets.BC_CLIENT_SECRET }}
        run: |
          # Get OAuth token directly with correct scope for BC API
          $tokenUrl = "https://login.microsoftonline.com/$($env:BC_TENANT_ID)/oauth2/v2.0/token"
          $tokenBody = @{
            client_id = $env:BC_CLIENT_ID
            client_secret = $env:BC_CLIENT_SECRET
            scope = "https://api.businesscentral.dynamics.com/.default"
            grant_type = "client_credentials"
          }

          Write-Host "Getting OAuth token..."
          try {
            $tokenResponse = Invoke-RestMethod -Uri $tokenUrl -Method Post -Body $tokenBody -ContentType "application/x-www-form-urlencoded"
            $accessToken = $tokenResponse.access_token
            Write-Host "Got access token (first 50 chars): $($accessToken.Substring(0, 50))..."
          } catch {
            Write-Host "Token Error: $($_.Exception.Message)"
            $errorBody = $_.ErrorDetails.Message
            Write-Host "Error Details: $errorBody"
            throw
          }

          Write-Host "Authenticated successfully"

          # Get the BC Online environment info to determine correct artifact version
          $environmentUrl = "https://api.businesscentral.dynamics.com/v2.0/$($env:BC_TENANT_ID)/Sandbox"

          # Get sandbox artifact matching BC Online version
          $artifactUrl = Get-BCArtifactUrl -type Sandbox -country us -select Latest
          Write-Host "Using artifact: $artifactUrl"

          # Create compiler folder from artifacts
          $compilerFolder = New-BcCompilerFolder -artifactUrl $artifactUrl -cacheFolder "c:\bccompiler"
          Write-Host "Compiler folder: $compilerFolder"

          # Find alc.exe in the compiler folder
          $alcExe = Join-Path $compilerFolder "extension\bin\win32\alc.exe"
          if (-not (Test-Path $alcExe)) {
            $alcExe = Join-Path $compilerFolder "extension\bin\alc.exe"
          }
          if (-not (Test-Path $alcExe)) {
            # Search recursively
            $alcExe = (Get-ChildItem -Path $compilerFolder -Filter "alc.exe" -Recurse | Select-Object -First 1).FullName
          }
          Write-Host "ALC path: $alcExe"

          # Get symbols from the compiler folder
          $symbolsFolder = Join-Path $compilerFolder "symbols"
          Write-Host "Symbols folder: $symbolsFolder"
          Get-ChildItem $symbolsFolder -Filter "*.app" | ForEach-Object { Write-Host "  - $($_.Name)" }

          # Create output folder
          $outputFolder = Join-Path $env:GITHUB_WORKSPACE "output"
          New-Item -ItemType Directory -Path $outputFolder -Force | Out-Null

          # Compile the app
          Write-Host "Compiling app..."
          $appJsonPath = Join-Path $env:GITHUB_WORKSPACE "app.json"
          $appJson = Get-Content $appJsonPath | ConvertFrom-Json
          $appFileName = "$($appJson.publisher)_$($appJson.name)_$($appJson.version).app"
          $appFilePath = Join-Path $outputFolder $appFileName

          & $alcExe /project:$env:GITHUB_WORKSPACE /packagecachepath:$symbolsFolder /out:$appFilePath /assemblyprobingpaths:$compilerFolder

          if (Test-Path $appFilePath) {
            Write-Host "Built app: $appFilePath"
          } else {
            Write-Host "Looking for any .app file in output..."
            Get-ChildItem $outputFolder
            throw "Failed to compile app"
          }

          # Deploy to Sandbox using REST API directly (BcContainerHelper has tenant URL bug)
          Write-Host "Publishing to Sandbox..."

          $automationApiUrl = "https://api.businesscentral.dynamics.com/v2.0/$($env:BC_TENANT_ID)/Sandbox/api/microsoft/automation/v2.0"
          Write-Host "Automation API URL: $automationApiUrl"

          $headers = @{
            "Authorization" = "Bearer $accessToken"
            "Content-Type" = "application/json"
          }

          # Get companies
          Write-Host "Getting companies..."
          try {
            $companiesResponse = Invoke-RestMethod -Uri "$automationApiUrl/companies" -Headers $headers -Method Get
            $company = $companiesResponse.value | Select-Object -First 1
            Write-Host "Using company: $($company.name) ($($company.id))"
          } catch {
            Write-Host "Companies API Error: $($_.Exception.Message)"
            Write-Host "Status Code: $($_.Exception.Response.StatusCode.value__)"
            $errorStream = $_.Exception.Response.GetResponseStream()
            $reader = New-Object System.IO.StreamReader($errorStream)
            $errorBody = $reader.ReadToEnd()
            Write-Host "Error Body: $errorBody"
            throw
          }

          # Upload extension
          Write-Host "Uploading extension..."
          $appContent = [System.IO.File]::ReadAllBytes($appFilePath)
          $base64App = [Convert]::ToBase64String($appContent)

          $uploadBody = @{
            "schedule" = "Current version"
            "schemaSyncMode" = "Force"
          } | ConvertTo-Json

          $uploadHeaders = @{
            "Authorization" = "Bearer $accessToken"
            "Content-Type" = "application/octet-stream"
            "If-Match" = "*"
          }

          $extensionUploadUrl = "$automationApiUrl/companies($($company.id))/extensionUpload/Microsoft.NAV.upload?SchemaUpdateMode=forcesync"
          Write-Host "Upload URL: $extensionUploadUrl"

          $appBytes = [System.IO.File]::ReadAllBytes($appFilePath)
          Invoke-RestMethod -Uri $extensionUploadUrl -Headers $uploadHeaders -Method Post -Body $appBytes

          Write-Host "Deployed to Sandbox successfully!"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: thyme-bc-extension-sandbox
          path: 'output/*.app'
          if-no-files-found: warn
