= Solution Design
:toc:

== Overview

The Thyme BC Extension provides custom API endpoints that expose Business Central Job, Job Task, Time Sheet, Resource, and Time Entry data with additional fields not available in the standard BC API v2.0.

== Problem Statement

The standard BC API v2.0 `/projects` endpoint only returns 4 fields:

* `id` - System GUID
* `number` - Job number
* `displayName` - Combined customer/project name
* `lastModifiedDateTime` - Last modified timestamp

This is insufficient for the Thyme time tracking app which needs:

* Customer name and number (for grouping projects by client)
* Person responsible (project manager)
* Project status (to filter active projects)
* Start/end dates (for project timeline)
* Job tasks (for time entry allocation)
* Time sheets with approval status (Open, Submitted, Approved, Rejected)
* Resources with capacity/hours targets
* Posted time entries from Job Ledger

== Architecture

[source]
----
┌─────────────────┐     ┌──────────────────────┐     ┌─────────────────┐
│   Thyme App     │────▶│  Custom API Pages    │────▶│   BC Tables     │
│  (TypeScript)   │     │  (AL Extension)      │     │   (Job, etc.)   │
└─────────────────┘     └──────────────────────┘     └─────────────────┘
         │                        │
         │                        │
         ▼                        ▼
   OAuth 2.0 Token          API Configuration:
   (Azure AD)               - APIGroup: thyme
                            - APIPublisher: knowall
                            - APIVersion: v1.0
----

== Time Entry Lifecycle

Understanding the distinction between Time Sheets and Time Entries is crucial for integrating with Business Central.

=== Lifecycle Diagram

[source]
----
User enters time    → timeSheetLine (Status: Open)
        ↓
User submits        → timeSheetLine (Status: Submitted)
        ↓
Manager approves    → timeSheetLine (Status: Approved)
        ↓
Posted to ledger    → timeEntry (Job Ledger Entry - permanent record)
----

=== Time Sheet Lines vs Time Entries

[cols="1,2,2", options="header"]
|===
| Aspect | `timeSheetLines` | `timeEntries`

| BC Table
| Time Sheet Line (table 951)
| Job Ledger Entry (table 169)

| Stage
| In approval workflow
| Posted to ledger (finalized)

| Status
| Open → Submitted → Approved
| N/A (already posted)

| Editable
| Yes (until posted)
| No (permanent accounting record)

| Purpose
| Track & approve time before posting
| Accounting, billing, historical reports
|===

=== When to Use Each Endpoint

* **`/timeSheets` and `/timeSheetLines`**: Use for approval workflows, viewing pending/submitted time entries, and editing unposted entries. These represent time that is still in the review process.

* **`/timeEntries`**: Use for finalized reports, billing calculations, and historical records. These are permanent ledger entries that cannot be modified.

== API Design

=== Endpoint Structure

[source]
----
https://api.businesscentral.dynamics.com/v2.0/{tenant}/{environment}/api/knowall/thyme/v1.0/companies({companyId})/projects
https://api.businesscentral.dynamics.com/v2.0/{tenant}/{environment}/api/knowall/thyme/v1.0/companies({companyId})/jobTasks
https://api.businesscentral.dynamics.com/v2.0/{tenant}/{environment}/api/knowall/thyme/v1.0/companies({companyId})/timeSheets
https://api.businesscentral.dynamics.com/v2.0/{tenant}/{environment}/api/knowall/thyme/v1.0/companies({companyId})/timeSheetLines
https://api.businesscentral.dynamics.com/v2.0/{tenant}/{environment}/api/knowall/thyme/v1.0/companies({companyId})/resources
https://api.businesscentral.dynamics.com/v2.0/{tenant}/{environment}/api/knowall/thyme/v1.0/companies({companyId})/timeEntries
----

=== Projects API (Page 50100)

Maps to the BC `Job` table (table 167).

[cols="1,1,1", options="header"]
|===
| API Field | BC Field | Notes

| id | SystemId | Primary key (GUID)
| number | No. | Job number
| description | Description | Project name
| billToCustomerNo | Bill-to Customer No. | Customer code
| billToCustomerName | Bill-to Name | Customer display name
| personResponsible | Person Responsible | Project manager
| status | Status | Enum: Planning, Quote, Open, Completed
| startingDate | Starting Date | Project start
| endingDate | Ending Date | Project end
| lastModifiedDateTime | SystemModifiedAt | For sync
|===

=== Job Tasks API (Page 50101)

Maps to the BC `Job Task` table (table 1001).

[cols="1,1,1", options="header"]
|===
| API Field | BC Field | Notes

| id | SystemId | Primary key (GUID)
| jobNo | Job No. | Parent job reference
| jobTaskNo | Job Task No. | Task number
| description | Description | Task name
| jobTaskType | Job Task Type | Enum: Posting, Heading, Total, Begin-Total, End-Total
| lastModifiedDateTime | SystemModifiedAt | For sync
|===

=== Time Sheets API (Page 50102)

Maps to the BC `Time Sheet Header` table (table 950).

[cols="1,1,1", options="header"]
|===
| API Field | BC Field | Notes

| id | SystemId | Primary key (GUID)
| number | No. | Time sheet number
| startingDate | Starting Date | Week start
| endingDate | Ending Date | Week end
| resourceNo | Resource No. | Associated resource
| ownerUserId | Owner User ID | Time sheet owner
| approverUserId | Approver User ID | Assigned approver
| openExists | Open Exists | True if any line is Open (FlowField)
| submittedExists | Submitted Exists | True if any line is Submitted (FlowField)
| rejectedExists | Rejected Exists | True if any line is Rejected (FlowField)
| approvedExists | Approved Exists | True if any line is Approved (FlowField)
| lastModifiedDateTime | SystemModifiedAt | For sync
|===

==== Bound Actions

The Time Sheets API supports the following bound actions for approval workflow:

[cols="1,2,2", options="header"]
|===
| Action | Endpoint | Description

| submit
| `POST /timeSheets({id})/Microsoft.NAV.submit`
| Submits the time sheet for approval

| approve
| `POST /timeSheets({id})/Microsoft.NAV.approve`
| Approves a submitted time sheet

| reject
| `POST /timeSheets({id})/Microsoft.NAV.reject`
| Rejects a submitted time sheet

| reopen
| `POST /timeSheets({id})/Microsoft.NAV.reopen`
| Reopens a rejected/approved time sheet for editing
|===

=== Time Sheet Lines API (Page 50103)

Maps to the BC `Time Sheet Line` table (table 951).

[cols="1,1,1", options="header"]
|===
| API Field | BC Field | Notes

| id | SystemId | Primary key (GUID)
| timeSheetNo | Time Sheet No. | Parent time sheet
| lineNo | Line No. | Line number
| timeSheetStartingDate | Time Sheet Starting Date | Week start
| type | Type | Enum: Resource, Job, Absence, Assembly Order, Service
| jobNo | Job No. | Job reference (if type=Job)
| jobTaskNo | Job Task No. | Task reference (if type=Job)
| description | Description | Line description
| causeOfAbsenceCode | Cause of Absence Code | Absence reason (if type=Absence)
| workTypeCode | Work Type Code | Work type
| chargeable | Chargeable | Billable flag
| totalQuantity | Total Quantity | Total hours
| status | Status | Enum: Open, Submitted, Rejected, Approved
| approvedBy | Approved By | Approver user ID
| approvalDate | Approval Date | Date approved
| posted | Posted | Whether posted to ledger
| lastModifiedDateTime | SystemModifiedAt | For sync
|===

==== Bound Actions

The Time Sheet Lines API supports the following bound actions for line-level approval:

[cols="1,2,2", options="header"]
|===
| Action | Endpoint | Description

| approve
| `POST /timeSheetLines({id})/Microsoft.NAV.approve`
| Approves a specific time sheet line

| reject
| `POST /timeSheetLines({id})/Microsoft.NAV.reject`
| Rejects a specific time sheet line

| reopen
| `POST /timeSheetLines({id})/Microsoft.NAV.reopen`
| Reopens a rejected/approved line for editing
|===

=== Resources API (Page 50104)

Maps to the BC `Resource` table (table 156).

[cols="1,1,1", options="header"]
|===
| API Field | BC Field | Notes

| id | SystemId | Primary key (GUID)
| number | No. | Resource number
| name | Name | Resource name
| searchName | Search Name | Search name for lookup
| type | Type | Enum: Person, Machine
| capacity | Capacity | Weekly hours target (FlowField)
| unitCost | Unit Cost | Cost per unit
| unitPrice | Unit Price | Price per unit
| baseUnitOfMeasure | Base Unit of Measure | Hour/Day units
| resourceGroupNo | Resource Group No. | Resource group code
| blocked | Blocked | Whether resource is blocked
| privacyBlocked | Privacy Blocked | Privacy blocked flag
| useTimeSheet | Use Time Sheet | Time sheet enabled
| timeSheetOwnerUserId | Time Sheet Owner User ID | Owner for time sheets
| timeSheetApproverUserId | Time Sheet Approver User ID | Approver for time sheets
| lastDateModified | Last Date Modified | Last modification date
| lastModifiedDateTime | SystemModifiedAt | For sync
|===

=== Time Entries API (Page 50105)

Maps to the BC `Job Ledger Entry` table (table 169). Filtered to Resource-type entries only.

[cols="1,1,1", options="header"]
|===
| API Field | BC Field | Notes

| id | SystemId | Primary key (GUID)
| entryNo | Entry No. | Ledger entry number
| jobNo | Job No. | Parent job
| jobTaskNo | Job Task No. | Task reference
| postingDate | Posting Date | Entry date
| type | Type | Entry type (filtered to Resource)
| number | No. | Resource/item number
| description | Description | Entry description
| quantity | Quantity | Hours/units
| unitCost | Unit Cost (LCY) | Cost per unit
| totalCost | Total Cost (LCY) | Total cost
| unitPrice | Unit Price (LCY) | Price per unit
| totalPrice | Total Price (LCY) | Total price
| workTypeCode | Work Type Code | Work classification
| entryType | Entry Type | Usage or Sale
| documentNo | Document No. | Source document
| lastModifiedDateTime | SystemModifiedAt | For sync
|===

=== Users API (Page 50106)

Returns all BC users with a computed field identifying the authenticated user.

Maps to the BC `User` table (virtual table 2000000120).

[cols="1,1,1", options="header"]
|===
| API Field | BC Field | Notes

| userSecurityId | User Security ID | Primary key (GUID)
| userName | User Name | BC user name
| fullName | Full Name | Display name
| isCurrentUser | (computed) | `true` if this is the authenticated user
| state | State | Enabled or Disabled
| expiryDate | Expiry Date | Account expiry
| authenticationEmail | Authentication Email | Auth email
| contactEmail | Contact Email | Contact email
| licenseType | License Type | BC license type
|===

**Usage:** Filter with `$filter=isCurrentUser eq true` to get only the authenticated user.

== Object ID Ranges

[cols="1,1", options="header"]
|===
| Object | ID

| Thyme Projects API | Page 50100
| Thyme Job Tasks API | Page 50101
| Thyme Time Sheet API | Page 50102
| Thyme Time Sheet Line API | Page 50103
| Thyme Resources API | Page 50104
| Thyme Time Entries API | Page 50105
| Thyme Users API | Page 50106
| Thyme Time Sheet Actions | Codeunit 50100
| (Reserved for future pages) | Page 50107-50199
| (Reserved for future codeunits) | Codeunit 50101-50199
|===

== Security

* APIs inherit BC's standard security model
* Users need appropriate permissions on Job, Job Task, Time Sheet, Resource, and Job Ledger Entry tables
* OAuth 2.0 authentication via Azure AD
* Supports both delegated and application permissions

== Future Enhancements

* **Time Entry Submission** - POST endpoint to submit new time entries to BC
* **Webhook support** - Real-time notifications when projects or time sheets change
